name: oneAPI

# Test Basix using Intel oneAPI compilers and MKL

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build and test (oneAPI)
    runs-on: ubuntu-latest
    container: ubuntu:24.04  # Run in container to test with minimal pre-installed packages
    env:
      CC: icx
      CXX: icpx
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Install compiler dependencies
        run: |
          apt-get -y update
          apt-get -y install binutils libstdc++-14-dev git
      # - name: Setup cmake
      #   uses: jwlawson/actions-setup-cmake@v2
      #   with:
      #     cmake-version: '3.30.x'
      # - name: Install required packages to install Intel compilers and to build
      #   run: apt -y update && apt install -y bzip2 git gnupg ninja-build make wget

      - uses: actions/checkout@v4

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: oneapi
          python-version: 3.12
          channels: https://software.repos.intel.com/python/conda,conda-forge
          # environment-file: python/conda-oneapi-test-env.yml
          auto-activate-base: false
      # - name: Check env
      #   run: |
      #     conda info --envs
      #     conda info
      #     conda list
      #     conda config --show-sources
      #     conda config --show
      #     printenv | sort

      - name: Check env (2)
        shell: bash -el {0}
        run: |
          conda info
          conda list
          # conda config --add channels defaults
          # conda config --add channels conda-forge
          # conda config --add channels https://software.repos.intel.com/python/conda
          # conda config --describe channel_priority
          conda create -n oneapi python=3.12 dpcpp_linux-64 cmake libblas=*=*mkl nanobind ninja numpy pip pytest pytest-xdist scikit-build-core uv

      - name: Check env (3)
        shell: bash -el {0}
        run: |
          # conda activate oneapi
          pip -v install .[test]
        # - name: Install Intel compilers and Intel Python
      #   run: |
      #     wget -O- https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB | gpg --dearmor | tee /usr/share/keyrings/oneapi-archive-keyring.gpg > /dev/null
      #     echo "deb [signed-by=/usr/share/keyrings/oneapi-archive-keyring.gpg] https://apt.repos.intel.com/oneapi all main" | tee /etc/apt/sources.list.d/oneAPI.list
      #     apt update
      #     apt install -y intel-oneapi-compiler-dpcpp-cpp intel-oneapi-mkl intel-oneapi-python libstdc++-11-dev
      # - name: Install Basix
      #   run: |
      #     conda info --envs
          # which conda
          # conda info
          # conda env list
      # - name: Run units tests
      #   run: |
      #     . /opt/intel/oneapi/setvars.sh
      #     pip install pytest-xdist
      #     pytest -n auto --durations 20 test/
      # - name: Run Python demos
      #   run: |
      #     . /opt/intel/oneapi/setvars.sh
      #     pytest demo/python/test.py
      # - name: Run C++ demos
      #   run: |
      #     . /opt/intel/oneapi/setvars.sh
      #     pytest demo/cpp/test.py
